<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SyncLink Pro - Hosted Edition</title>
    <style>
        :root { --accent: #00ff88; --panel-bg: rgba(20, 20, 20, 0.9); }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; font-family: sans-serif; overflow: hidden; color: white; }

        /* Master Player */
        #youtube-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Floating PiP */
        #pip-window {
            position: absolute; top: 40px; right: 40px;
            width: 450px; background: #000;
            border: 2px solid var(--accent); z-index: 100;
            resize: both; overflow: hidden;
            display: flex; flex-direction: column; cursor: move;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        #local-video { width: 100%; display: block; pointer-events: none; }

        /* HUD */
        #hud {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 101; background: var(--panel-bg);
            padding: 15px 25px; border-radius: 50px;
            display: flex; gap: 20px; align-items: center;
            border: 1px solid #444; backdrop-filter: blur(10px);
        }

        input, button { background: #333; color: white; border: 1px solid #555; padding: 8px 12px; border-radius: 20px; outline: none; }
        button { cursor: pointer; border: none; font-weight: bold; background: var(--accent); color: #000; }
        .nudge { background: #444; color: white; padding: 5px 10px; font-size: 11px; }
        
        #status-pill { font-size: 10px; padding: 4px 10px; border-radius: 10px; background: #cc0000; color: white; }
    </style>
</head>
<body>

    <div id="youtube-layer"><div id="player"></div></div>

    <div id="pip-window">
        <video id="local-video" preload="auto"></video>
        <div style="background: var(--accent); color: #000; font-size: 10px; padding: 4px 10px; font-weight: bold; display: flex; justify-content: space-between;">
            <span>LOCAL SLAVE</span>
            <span id="drift-val">DRIFT: 0ms</span>
        </div>
    </div>

    <div id="hud">
        <div id="status-pill">API DISCONNECTED</div>
        <input type="text" id="yt-url" placeholder="YouTube URL" style="width: 150px;">
        <button onclick="initMaster()">LOAD MASTER</button>
        
        <input type="file" id="local-file" accept="video/*" style="width: 150px; font-size: 10px;">

        <div style="display:flex; flex-direction: column; align-items: center;">
            <label style="font-size: 9px; color: #888;">OFFSET (SEC)</label>
            <input type="number" id="offset" value="0" step="0.1" style="width: 60px;">
        </div>

        <div style="display:flex; gap:2px;">
            <button class="nudge" onclick="adjustOffset(-0.005)">-5ms</button>
            <button class="nudge" onclick="adjustOffset(0.005)">+5ms</button>
        </div>
    </div>

    <script>
        // Load YouTube API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        let player;
        const local = document.getElementById('local-video');
        const status = document.getElementById('status-pill');

        function onYouTubeIframeAPIReady() {
            status.innerText = "API READY";
            status.style.background = "#0066ff";
        }

        function initMaster() {
            const val = document.getElementById('yt-url').value;
            const id = val.match(/[a-zA-Z0-9_-]{11}/);
            if(!id) return;

            if(player) player.destroy();

            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: id[0],
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                events: {
                    'onStateChange': (e) => {
                        if(e.data == YT.PlayerState.PLAYING) local.play();
                        else if(e.data == YT.PlayerState.PAUSED) local.pause();
                    }
                }
            });
            status.innerText = "CONNECTED";
            status.style.background = "#00ff88";
            status.style.color = "#000";
        }

        document.getElementById('local-file').onchange = (e) => {
            local.src = URL.createObjectURL(e.target.files[0]);
        };

        function adjustOffset(amt) {
            const el = document.getElementById('offset');
            el.value = (parseFloat(el.value) + amt).toFixed(3);
        }

        // AUTO-SYNC HEARTBEAT
        setInterval(() => {
            if(player && player.getCurrentTime && local.src) {
                const ytTime = player.getCurrentTime();
                const offset = parseFloat(document.getElementById('offset').value) || 0;
                const target = ytTime - offset;

                if(target > 0) {
                    const drift = local.currentTime - target;
                    document.getElementById('drift-val').innerText = `DRIFT: ${Math.round(drift * 1000)}ms`;
                    
                    // Force re-sync if drift > 150ms
                    if(Math.abs(drift) > 0.150) {
                        local.currentTime = target;
                    }
                }
            }
        }, 500);

        // DRAG LOGIC
        const pip = document.getElementById('pip-window');
        let drag = false, offX, offY;
        pip.onmousedown = (e) => { if(e.target.tagName === 'INPUT') return; drag = true; offX = pip.offsetLeft - e.clientX; offY = pip.offsetTop - e.clientY; };
        document.onmousemove = (e) => { if(drag) { pip.style.left = (e.clientX + offX) + 'px'; pip.style.top = (e.clientY + offY) + 'px'; } };
        document.onmouseup = () => drag = false;
    </script>
</body>
</html>