<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SyncLink Pro - v1.5 Stable Sync</title>
    <style>
        :root { --accent: #00ff88; --panel-bg: rgba(15, 15, 15, 0.95); }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; font-family: sans-serif; overflow: hidden; color: white; }
        #youtube-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #pip-window {
            position: absolute; top: 40px; right: 40px;
            width: 450px; background: #000; border: 2px solid var(--accent); 
            z-index: 100; display: flex; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); overflow: hidden; touch-action: none;
        }
        #pip-header { background: var(--accent); color: #000; font-size: 10px; font-weight: bold; padding: 6px 12px; cursor: grab; user-select: none; display: flex; justify-content: space-between; }
        #local-video { width: 100%; height: 100%; display: block; pointer-events: none; object-fit: contain; }
        #hud {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 101; background: var(--panel-bg); padding: 12px 25px; border-radius: 50px;
            display: flex; gap: 20px; align-items: center; border: 1px solid #444; backdrop-filter: blur(10px);
        }
        button { cursor: pointer; border: none; font-weight: bold; background: var(--accent); color: #000; padding: 8px 16px; border-radius: 20px; }
        .nudge { background: #333; color: white; padding: 5px 10px; font-size: 11px; }
        input { background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="youtube-layer"><div id="player"></div></div>

    <div id="pip-window">
        <div id="pip-header"><span>SYNC ACTIVE</span><span id="drift-val">0ms</span></div>
        <video id="local-video" preload="auto"></video>
    </div>

    <div id="hud">
        <input type="text" id="yt-url" placeholder="YouTube ID or URL" style="width: 140px;">
        <button onclick="initMaster()">LOAD MASTER</button>
        <input type="file" id="local-file" accept="video/*">
        <input type="number" id="offset" value="0" step="0.001" style="width: 80px;">
        <div style="display:flex; gap:2px;">
            <button class="nudge" onclick="adjustOffset(-0.005)">-5ms</button>
            <button class="nudge" onclick="adjustOffset(0.005)">+5ms</button>
        </div>
    </div>

    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        let player;
        const local = document.getElementById('local-video');
        const pip = document.getElementById('pip-window');

        function initMaster() {
            const val = document.getElementById('yt-url').value;
            const id = val.match(/[a-zA-Z0-9_-]{11}/);
            if(!id) return;
            if(player) player.destroy();

            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: id[0],
                playerVars: { 'autoplay': 1, 'controls': 1, 'enablejsapi': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            // Force local video to match play/pause state immediately on change
            if (event.data == YT.PlayerState.PLAYING) local.play();
            else local.pause();
        }

        document.getElementById('local-file').onchange = (e) => {
            local.src = URL.createObjectURL(e.target.files[0]);
            local.onloadedmetadata = () => {
                pip.style.aspectRatio = (local.videoWidth / local.videoHeight).toString();
            };
        };

        // --- THE FIXED SYNC ENGINE ---
        setInterval(() => {
            if (!player || !player.getCurrentTime || !local.src || local.readyState < 2) return;

            const ytTime = player.getCurrentTime();
            const ytState = player.getPlayerState();
            const offset = parseFloat(document.getElementById('offset').value) || 0;
            const target = ytTime - offset;

            // 1. Position Sync (Handling Seeks and Drift)
            if (target >= 0) {
                const drift = local.currentTime - target;
                document.getElementById('drift-val').innerText = `${Math.round(drift * 1000)}ms`;

                // If drift > 150ms OR if the local video has stopped but YT is playing
                if (Math.abs(drift) > 0.150) {
                    local.currentTime = target;
                }
            } else {
                local.currentTime = 0;
                local.pause();
            }

            // 2. State Sync (The "Buffering" Fix)
            // If YouTube is playing but local is stuck (often after a seek), force play.
            if (ytState === YT.PlayerState.PLAYING && local.paused && target >= 0) {
                local.play();
            } 
            // If YouTube is paused/buffering but local is still running, force pause.
            else if ((ytState === YT.PlayerState.PAUSED || ytState === YT.PlayerState.BUFFERING) && !local.paused) {
                local.pause();
            }

        }, 200); // Increased frequency to 200ms for tighter seek-detection

        // Smooth Drag
        let isDragging = false, startX, startY, initialX, initialY;
        const header = document.getElementById('pip-header');
        header.onmousedown = (e) => {
            isDragging = true; startX = e.clientX; startY = e.clientY;
            initialX = pip.offsetLeft; initialY = pip.offsetTop;
        };
        document.onmousemove = (e) => {
            if (!isDragging) return;
            pip.style.left = (initialX + (e.clientX - startX)) + 'px';
            pip.style.top = (initialY + (e.clientY - startY)) + 'px';
            pip.style.right = 'auto';
        };
        document.onmouseup = () => isDragging = false;

        // Spacebar
        window.onkeydown = (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                const state = player.getPlayerState();
                if (state === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            }
        };

        function adjustOffset(amt) {
            const el = document.getElementById('offset');
            el.value = (parseFloat(el.value) + amt).toFixed(3);
        }
    </script>
</body>
</html>
